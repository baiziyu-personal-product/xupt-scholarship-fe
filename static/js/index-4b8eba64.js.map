{"version":3,"file":"index-4b8eba64.js","sources":["../../../src/components/update-user-info/index.tsx"],"sourcesContent":["import { Button, DatePicker, Form, Input, InputNumber, message, Radio, Upload } from 'antd';\r\nimport { disabledFormFeatureYear, requiredRule, validateMessages } from '@/config/form';\r\nimport * as React from 'react';\r\nimport { LoadingOutlined, UserOutlined } from '@ant-design/icons';\r\nimport style from './style.module.less';\r\nimport * as uploadApi from '@/service/upload';\r\nimport * as userApi from '@/service/user';\r\nimport { useAuth } from '@/context/auth.context';\r\nimport { use } from 'echarts';\r\nimport moment from 'moment';\r\n\r\nexport interface CompleteUserInfoValue {\r\n  avatar: string;\r\n  name: string;\r\n  phone: string;\r\n  user_id: string;\r\n  student?: IStudentInfo;\r\n  manager?: IManagerInfo;\r\n}\r\n\r\nconst StudentTypeOptions: {\r\n  key: IStudentInfo['type'];\r\n  value: IStudentInfo['type'];\r\n  label: string;\r\n}[] = [\r\n    {\r\n      label: \"学硕\",\r\n      value: \"bachelor_degree\",\r\n      key: \"bachelor_degree\"\r\n    },\r\n    {\r\n      label: \"专硕\",\r\n      value: \"profession_degree\",\r\n      key: \"profession_degree\"\r\n    }\r\n  ]\r\n\r\ninterface IProps {\r\n  formValue: CompleteUserInfoValue;\r\n}\r\n\r\nconst StudentForm = () => (\r\n  <Form.Item noStyle name=\"student\">\r\n    <Form.Item\r\n      name={[\"student\", \"college\"]}\r\n      label=\"学院\"\r\n      rules={requiredRule}\r\n    >\r\n      <Input />\r\n    </Form.Item>\r\n    <Form.Item\r\n      name={[\"student\", \"professional\"]}\r\n      label=\"专业\"\r\n      rules={requiredRule}\r\n    >\r\n      <Input />\r\n    </Form.Item>\r\n    <Form.Item\r\n      name={[\"student\", \"grade\"]}\r\n      label=\"年级\"\r\n      rules={requiredRule}\r\n    >\r\n      <DatePicker picker=\"year\" suffixIcon={\"级\"} disabledDate={disabledFormFeatureYear} />\r\n    </Form.Item>\r\n    <Form.Item\r\n      name={[\"student\", \"class\"]}\r\n      label=\"班级\"\r\n      rules={requiredRule}\r\n    >\r\n      <InputNumber\r\n        min={1}\r\n        precision={0}\r\n        addonAfter=\"班\"\r\n      />\r\n    </Form.Item>\r\n    <Form.Item\r\n      name={[\"student\", \"type\"]}\r\n      label=\"硕士类型\"\r\n      rules={requiredRule}\r\n    >\r\n      <Radio.Group\r\n        buttonStyle=\"solid\"\r\n        options={StudentTypeOptions}\r\n        optionType=\"button\"\r\n      />\r\n    </Form.Item>\r\n  </Form.Item>\r\n)\r\n\r\nconst ManagerForm = () => (\r\n  <Form.Item noStyle name=\"manager\">\r\n    <Form.Item\r\n      name={[\"manager\", \"department\"]}\r\n      label=\"部门/学院\"\r\n      rules={requiredRule}\r\n    >\r\n      <Input placeholder=\"部门\" />\r\n    </Form.Item>\r\n    <Form.Item\r\n      name={[\"manager\", \"office\"]}\r\n      label=\"办公室/组\"\r\n      rules={requiredRule}\r\n    >\r\n      <Input placeholder=\"办公室\" />\r\n    </Form.Item>\r\n    <Form.Item\r\n      name={[\"manager\", \"position\"]}\r\n      label=\"职位\"\r\n      rules={requiredRule}\r\n    >\r\n      <Input placeholder=\"职位\" />\r\n    </Form.Item>\r\n  </Form.Item>\r\n)\r\n\r\nconst UploadUserInfo: React.FC<IProps> = (props) => {\r\n  const { formValue } = props;\r\n  const [form] = Form.useForm();\r\n  const { user } = useAuth();\r\n  const [imgUrl, setImgUrl] = React.useState(formValue.avatar);\r\n  const [loading, setLoading] = React.useState(false);\r\n  const [file, setFile] = React.useState<any>(null);\r\n  const uploadAvatarImg = async () => {\r\n    if (!file) return;\r\n    try {\r\n      setLoading(true);\r\n      const url = await uploadApi.postAvatar(file);\r\n      setImgUrl(`http://127.0.0.1:8096${url}`)\r\n      message.success(\"上传成功\");\r\n    } catch (error) {\r\n      message.error(\"上传失败\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  const updateUserInfo = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const value = await form.validateFields();\r\n      await userApi.postUpdateUserInfo({\r\n        avatar: imgUrl,\r\n        ...value\r\n      });\r\n      message.success(\"完善个人信成功\");\r\n      location.reload();\r\n    } catch (error) {\r\n      message.error(\"完善个人信息失败\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  React.useMemo(() => {\r\n    uploadAvatarImg();\r\n  }, [file]);\r\n\r\n  const uploadButton = (\r\n    <div>\r\n      {loading ? <LoadingOutlined /> : <UserOutlined />}\r\n      <div className={style['upload-avatar-text']}>上传头像</div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <Form\r\n      form={form}\r\n      initialValues={{\r\n        ...user,\r\n        student: {\r\n          ...user.student,\r\n          grade: moment(user.student?.grade || undefined)\r\n        }\r\n      }}\r\n      validateMessages={validateMessages}\r\n      labelAlign=\"left\"\r\n      {\r\n      ...{\r\n        labelCol: { span: 6, offset: 2 },\r\n        wrapperCol: { span: 12 },\r\n      }\r\n      }\r\n    >\r\n      <Upload\r\n        listType=\"picture-card\"\r\n        showUploadList={false}\r\n        className={style['upload-avatar-box']}\r\n        maxCount={1}\r\n        beforeUpload={(file) => {\r\n          setFile(file);\r\n          return false;\r\n        }}\r\n      >\r\n        {imgUrl ? <img src={imgUrl} alt=\"avatar\" style={{ width: '100%' }} /> : uploadButton}\r\n      </Upload>\r\n      <Form.Item\r\n        name=\"name\"\r\n        label=\"姓名\"\r\n        rules={requiredRule}\r\n      >\r\n        <Input placeholder=\"请输入你的姓名\" />\r\n      </Form.Item>\r\n      <Form.Item\r\n        name=\"phone\"\r\n        label=\"手机号\"\r\n        rules={requiredRule}\r\n      >\r\n        <Input type=\"tel\" placeholder=\"请填写你的常用手机号\" />\r\n      </Form.Item>\r\n      <Form.Item\r\n        name=\"user_id\"\r\n        label=\"学号/工号\"\r\n        rules={requiredRule}\r\n      >\r\n        <Input placeholder=\"请输入您的学号/工号\" />\r\n      </Form.Item>\r\n      {\r\n        user.identity === 'manager'\r\n          ? <ManagerForm />\r\n          : <StudentForm />\r\n      }\r\n      <Button\r\n        type=\"primary\"\r\n        block\r\n        loading={loading}\r\n        disabled={loading}\r\n        onClick={updateUserInfo}\r\n        className={style['submit-btn']}\r\n      >更新个人信息</Button>\r\n    </Form >\r\n  );\r\n};\r\n\r\nUploadUserInfo.defaultProps = {\r\n  formValue: {\r\n    avatar: '',\r\n    name: '',\r\n    phone: '',\r\n    user_id: '',\r\n  }\r\n}\r\n\r\nexport default React.memo(UploadUserInfo);"],"names":["React.useState","uploadApi.postAvatar","userApi.postUpdateUserInfo","React.memo"],"mappings":"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"}